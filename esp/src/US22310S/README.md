# ESP8266 NodeMCU US22310S 超声波测距模块 Demo

## 项目简介

本项目演示如何使用ESP8266 NodeMCU通过I2C接口控制US22310S超声波测距模块，实现距离测量功能。

## 硬件信息

### US22310S超声波模块参数
- **型号**: US22310S（属于 US223xxS 系列）
- **工作电压**: 4.5 V – 5.5 V
- **测量范围**: 15 mm – 1000 mm（盲区 <15 mm）
- **通信接口**: I²C 总线 + INT 中断输出
- **I²C 地址**: 0x72（写地址），0x73（读地址，即 0x72 + 1）

### 接口定义（5P 接口）
| 引脚 | 功能说明 |
|------|----------|
| VCC  | 电源正极（4.5–5.5 V） |
| GND  | 电源地 |
| SCL  | I²C 时钟线 |
| SDA  | I²C 数据线 |
| INT  | 中断输出信号线 |

## 硬件连接

将US22310S超声波模块连接到ESP8266 NodeMCU：

| 模块引脚 | NodeMCU引脚 | 功能 |
|----------|-------------|------|
| VCC      | 5V          | 电源正极 |
| GND      | GND         | 电源地 |
| SCL      | D1 (GPIO5)  | I²C 时钟线 |
| SDA      | D2 (GPIO4)  | I²C 数据线 |
| INT      | 不连接      | 中断输出（本Demo不使用） |

## 软件配置

### PlatformIO 项目配置

项目已配置为使用ESP8266 NodeMCU平台，主要配置文件 `platformio.ini`：

```ini
[env:nodemcu]
platform = espressif8266
board = nodemcu
framework = arduino

monitor_speed = 115200
```

### 依赖库

本项目依赖以下Arduino库：
- `Wire.h` - I2C通信库（Arduino核心库）

## 功能说明

### 主要功能
1. **I2C通信初始化**: 自动配置I2C引脚和通信参数
2. **设备检测**: 自动检测超声波模块是否正确连接
3. **单次测量**: 启动单次距离测量
4. **数据读取**: 读取测量距离值（毫米和厘米）
5. **错误处理**: 检测和处理通信错误、异常测量值

### 工作模式
本Demo使用**单次测量模式**：
- 发送命令：`0x72`（地址） + `0x50`（指令） + `0x10`（启动测量）
- 读取数据：发送读地址 `0x73`，读取1字节数据（距离值，单位 mm）

## 使用方法

### 1. 硬件连接
按照上述表格连接超声波模块和NodeMCU。

### 2. 编译和上传
使用PlatformIO编译并上传程序到ESP8266 NodeMCU：
```bash
# 在项目根目录执行
pio run -t upload
```

### 3. 串口监视
上传完成后，打开串口监视器（波特率：115200）查看测量结果。

### 4. 预期输出
```
ESP8266 NodeMCU US22310S 超声波测距 Demo
==========================================
I2C 初始化完成
US22310S 超声波模块检测成功！
I2C 地址: 0x73
系统初始化完成，开始测量...

测量命令发送成功
测量距离: 150 mm
距离: 15.00 cm

测量命令发送成功
测量距离: 200 mm
距离: 20.00 cm
```

## 代码结构

### 文件说明
- `include/iic.h` - I2C通信类定义
- `src/iic.cpp` - I2C通信类实现
- `src/main.cpp` - 主程序，包含测距逻辑

### 主要类和方法

#### US22310S_I2C 类
- `US22310S_I2C(scl_pin, sda_pin)` - 构造函数
- `begin()` - 初始化I2C通信
- `startSingleMeasurement()` - 启动单次测量
- `readDistance(distance_mm)` - 读取距离值
- `checkDevice()` - 检查设备是否在线

## 扩展功能

### 阈值中断模式
如需使用阈值中断模式，可以调用以下方法：
```cpp
// 设置阈值为100mm
ultrasonic.setThresholdMode(100);
```

### 自定义I2C引脚
如需使用其他I2C引脚：
```cpp
// 使用自定义引脚
US22310S_I2C ultrasonic(D3, D4);  // SCL=D3, SDA=D4
```

## 故障排除

### 常见问题

1. **无法检测到设备**
   - 检查接线是否正确
   - 确认电源电压（4.5-5.5V）
   - 检查I2C上拉电阻（通常需要4.7KΩ）

2. **测量值异常**
   - 确保测量范围内有反射面
   - 检查是否有其他超声波干扰
   - 确认盲区（<15mm）内无障碍物

3. **通信错误**
   - 检查I2C时钟频率（本程序使用100kHz）
   - 确认I2C地址正确（0x72写，0x73读）

### 调试技巧
1. 使用 `Wire.begin()` 和 `Wire.setClock()` 调整I2C参数
2. 添加 `delay()` 确保测量完成
3. 检查串口输出错误信息

## 技术支持

如需技术支持，请联系制造商：
- **制造商**: EMFLYTEK® / Infeeon
- **电话/微信**: 13823123830、18870367569
- **邮箱**: support_infeeon@126.com、sales_infeeon@126.com
- **QQ**: 3462348702
- **地址**: 深圳市龙华区观湖街道下围工业区一路6号智谷C2栋411-413

## 许可证

本项目仅供学习和参考使用。
