# ESP32-C3 与 STM32F103 接线指南

## 引脚连接图

```
┌─────────────────┐              ┌─────────────────┐
│   ESP32-C3      │              │   STM32F103     │
│                 │              │                 │
│  GPIO21 (TX) ───┼──────────────┼───> PA10 (RX)   │
│                 │              │                 │
│  GPIO20 (RX) <──┼──────────────┼──── PA9  (TX)   │
│                 │              │                 │
│  GND ───────────┼──────────────┼──── GND         │
│                 │              │                 │
│  3.3V (可选)    │              │  3.3V (可选)    │
└─────────────────┘              └─────────────────┘
```

## 详细连接说明

### 1. 串口信号线（必须）

| ESP32-C3 引脚 | 方向 | STM32F103 引脚 | 说明 |
|--------------|------|---------------|------|
| GPIO21 | TX → | PA10 (USART1_RX) | ESP32发送，STM32接收 |
| GPIO20 | RX ← | PA9 (USART1_TX) | ESP32接收，STM32发送 |
| GND | - | GND | 共地（非常重要！） |

### 2. 电源连接（可选）

**方案A：独立供电（推荐）**
- ESP32-C3: 通过USB或外部3.3V供电
- STM32F103: 通过ST-Link或外部电源供电
- 只需连接GND共地

**方案B：共享电源**
- 如果ESP32-C3通过USB供电，可以用其3.3V输出给STM32供电
- 注意：ESP32-C3的3.3V输出能力有限（约500mA），确保STM32负载不要太大

## 硬件注意事项

### ⚠️ 重要提示

1. **电平兼容性**: ESP32-C3和STM32F103都是3.3V逻辑，可以直接连接
2. **共地**: 必须连接GND，否则通信会不稳定或失败
3. **交叉连接**: TX连RX，RX连TX（不要连错！）
4. **电源**: 如果共享电源，注意电流容量

### 🔧 调试技巧

1. **使用万用表**
   - 测量ESP32-C3的3.3V输出是否正常
   - 确认GND已连接

2. **使用逻辑分析仪**
   - 监控TX/RX信号
   - 确认波特率是否正确（115200）
   - 检查数据格式（8N1）

3. **LED指示**
   - 可以在TX/RX线上串联LED观察数据传输（需要加限流电阻）

## 引脚复用说明

### ESP32-C3 引脚选择

如果GPIO20/21被占用，可以修改为其他引脚：

```cpp
// 在 ble_uart_bridge.h 中修改
#define UART_TX_PIN 6   // 改为GPIO6
#define UART_RX_PIN 7   // 改为GPIO7
```

ESP32-C3可用的GPIO：
- GPIO0-GPIO10, GPIO18-GPIO21
- 注意：GPIO2, GPIO8, GPIO9用于SPI Flash，尽量避免使用

### STM32F103 串口选择

如果USART1被占用，可以使用其他串口：

**USART2:**
- PA2 (TX) ← ESP32 RX
- PA3 (RX) ← ESP32 TX

**USART3:**
- PB10 (TX) ← ESP32 RX
- PB11 (RX) ← ESP32 TX

## 测试步骤

### 1. 硬件测试

1. 断电状态下完成所有连接
2. 先给ESP32-C3上电，检查是否正常启动
3. 再给STM32上电
4. 观察两个设备的电源指示灯

### 2. 回环测试

**ESP32-C3端:**
```cpp
// 在setup()中添加
Serial1.println("ESP32 Test");
```

**STM32端:**
```c
// 接收并打印
HAL_UART_Receive(&huart1, rxBuffer, 10, 1000);
```

### 3. 蓝牙测试

1. 手机连接ESP32-C3蓝牙
2. 发送测试数据："Hello"
3. STM32应该能收到数据
4. STM32回复数据，手机应该能收到

## 常见问题排查

### 问题1: STM32收不到数据

**检查清单:**
- [ ] GND是否连接
- [ ] TX/RX是否交叉连接（不是直连）
- [ ] 波特率是否匹配（115200）
- [ ] ESP32是否正常启动（查看USB串口输出）
- [ ] STM32串口是否正确初始化

**测试方法:**
```c
// STM32端发送测试
HAL_UART_Transmit(&huart1, (uint8_t*)"Test\n", 5, 100);
// 在ESP32的串口监视器应该能看到 "STM32->BLE: 5 bytes"
```

### 问题2: 数据乱码

**可能原因:**
- 波特率不匹配
- 数据位/停止位/校验位设置不同
- 接线松动或接触不良

**解决方法:**
- 确认两端都是 115200, 8N1
- 重新检查接线
- 尝试降低波特率到9600测试

### 问题3: 偶尔丢数据

**可能原因:**
- 缓冲区太小
- 处理速度跟不上
- 没有流控

**解决方法:**
- 增大接收缓冲区
- 使用DMA接收
- 降低发送速率
- 添加握手协议

## 进阶配置

### 使用硬件流控

如果需要更可靠的通信，可以添加RTS/CTS流控：

```
ESP32-C3 GPIO4 (RTS) → STM32 PA12 (CTS)
ESP32-C3 GPIO5 (CTS) ← STM32 PA11 (RTS)
```

### 使用更高波特率

如果需要更高的传输速度：

```cpp
// ESP32端
#define UART_BAUD_RATE 921600

// STM32端
huart1.Init.BaudRate = 921600;
```

注意：更高波特率对线材质量和长度要求更高。

## 推荐硬件

### 杜邦线
- 长度：10-20cm（越短越好）
- 质量：使用质量好的杜邦线，避免接触不良

### 面包板
- 如果使用面包板，确保接触良好
- 建议使用焊接连接以获得最佳稳定性

### 电源
- ESP32-C3: USB供电或3.3V稳压电源（≥500mA）
- STM32F103: ST-Link供电或3.3V-5V电源（根据板子而定）
