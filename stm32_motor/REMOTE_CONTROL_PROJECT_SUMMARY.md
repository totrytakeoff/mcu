# TLE100 遥控器项目总结

## ✅ 已完成的工作

### 1. 官方 Demo 分析
- ✅ 提取 MCU 型号：**STC89C52 / AT89S52**
- ✅ 提取晶振频率：**11.0592MHz**
- ✅ 提取串口配置：**9600 8N1**
- ✅ 提取按键映射：10 个按键 (F/B/L/R/U/D/W/X/Y/Z)
- ✅ 提取 E49 配置：透传模式 (M0=0, M1=0)
- ✅ 分析代码逻辑：轮询检测 + 延时 200ms

### 2. PlatformIO 项目创建
- ✅ 项目初始化：`remote_control_pio/`
- ✅ 配置文件：`platformio.ini`
- ✅ 模块化设计：
  - `config.h` - 硬件配置
  - `uart.h/c` - 串口通信
  - `keys.h/c` - 按键检测
  - `main.c` - 主程序

### 3. 代码改进
| 特性 | 官方 Demo | 新项目 |
|------|-----------|--------|
| **按键去抖** | ❌ 无 | ✅ 20ms 软件去抖 |
| **多键处理** | ❌ 全发送 | ✅ 单键优先 |
| **代码结构** | ❌ 单文件 | ✅ 模块化 |
| **注释文档** | ❌ 中文乱码 | ✅ 完整英文 |
| **可移植性** | ❌ Keil 专用 | ✅ PlatformIO |

---

## 📊 硬件配置对比

### 原始遥控器 (官方)
```
MCU: STC89C52
晶振: 11.0592MHz
按键: P0.0-P0.7, P1.3-P1.4
E49: P1.1 (M0), P1.2 (M1)
UART: P3.0 (RXD), P3.1 (TXD)
```

### STM32 小车接收端 (你的项目)
```
MCU: STM32F103RC
E49: PA6 (M0), PA7 (M1), PA12 (AUX)
UART: USART1 (PA9/PA10)
```

---

## 🎯 按键映射总结

### 标准映射 (新项目)
| 按键 | GPIO | 字符 | 功能 |
|------|------|------|------|
| Forward | P0.2 | **'F'** | 前进 |
| Back | P0.3 | **'B'** | 后退 |
| Left | P0.0 | **'L'** | 左转 |
| Right | P0.1 | **'R'** | 右转 |
| SpeedUp | P0.4 | **'U'** | 加速 |
| SpeedDown | P0.5 | **'D'** | 减速 |
| F1 | P0.6 | **'W'** | 功能1 (前进+左转) |
| F2 | P0.7 | **'X'** | 功能2 (后退+左转) |
| F3 | P1.3 | **'Y'** | 功能3 (前进+右转) |
| F4 | P1.4 | **'Z'** | 功能4 (后退+右转) |

---

## 🔄 工作流程

### 遥控器端 (STC89C52)
```
1. 初始化 UART (9600)
2. 初始化 E49 (透传模式)
3. 主循环:
   ├─ 扫描按键 (带去抖)
   ├─ 如果有按键: UART 发送字符
   └─ 延时 100ms
```

### 小车端 (STM32F103RC)
```
1. 初始化 USART1 (9600)
2. 初始化 E49 (透传模式)
3. UART 中断接收:
   ├─ 接收字符 → E49::onDataReceived()
   ├─ 回调 → RemoteControl::handleCommand()
   ├─ LED 显示 (二进制调试)
   ├─ 计算目标速度 (累积加速)
   └─ DriveTrain::setTargetSpeed()
4. 主循环 (10ms):
   ├─ DriveTrain::update() (梯形速度轮廓)
   └─ RemoteControl::update() (超时检测)
```

---

## 📁 项目文件结构

### 遥控器项目
```
remote_control_pio/
├── platformio.ini
├── include/
│   ├── config.h      (硬件配置)
│   ├── uart.h        (串口接口)
│   └── keys.h        (按键接口)
├── src/
│   ├── main.c        (主程序)
│   ├── uart.c        (UART 实现)
│   └── keys.c        (按键检测)
└── README.md
```

### 小车项目
```
stm32_pio/
├── platformio.ini
├── include/
│   ├── motor.hpp            (电机控制)
│   ├── motion_profile.hpp   (速度轮廓)
│   ├── drive_train.hpp      (差速转向)
│   ├── e49_wireless.hpp     (E49 通信)
│   ├── remote_control.hpp   (遥控处理)
│   └── gpio.h               (GPIO/LED)
├── src/
│   └── ... (实现文件)
└── docs/
    ├── ARCHITECTURE.md      (架构说明)
    ├── LED_DEBUG_GUIDE.md   (LED 调试)
    └── ...
```

---

## 🛠️ 下一步操作

### 1. 完成遥控器编译
```bash
cd remote_control_pio
pio run  # 等待 SDCC 编译器下载完成
```

### 2. 烧录遥控器
```bash
# 方法 A: PlatformIO
pio run -t upload

# 方法 B: STC-ISP (Windows)
# 使用图形界面烧录 firmware.hex
```

### 3. 测试通信
1. 遥控器上电
2. 小车上电
3. 按下遥控器按键
4. 观察小车 LED 显示 (PB5/12/13/14)
5. 观察小车动作

### 4. 调试映射
如果 LED 显示和预期不符：
1. 记录所有按键的 LED 显示
2. 根据 `LED_ASCII_DEBUG.md` 对照分析
3. 修改小车端 `RemoteControl::handleCommand()` 适配实际字符

---

## 📊 通信协议

### 数据格式
```
遥控器 → E49发送端 → 433MHz → E49接收端 → 小车
  ↓          ↓                    ↓         ↓
按键      UART发送            UART接收    处理
字符      (9600)              (9600)      指令
```

### 字符编码 (ASCII)
| 字符 | ASCII | 十六进制 | 二进制 | LED显示 |
|------|-------|---------|--------|---------|
| 'F' | 70 | 0x46 | 01000110 | ○○○● (1) |
| 'B' | 66 | 0x42 | 01000010 | ○○●○ (2) |
| 'L' | 76 | 0x4C | 01001100 | ○○●● (3) |
| 'R' | 82 | 0x52 | 01010010 | ○●○○ (4) |
| 'U' | 85 | 0x55 | 01010101 | ○●○● (5) |
| 'D' | 68 | 0x44 | 01000100 | ○●●○ (6) |
| 'W' | 87 | 0x57 | 01010111 | ○●●● (7) |
| 'X' | 88 | 0x58 | 01011000 | ●○○○ (8) |
| 'Y' | 89 | 0x59 | 01011001 | ●○○● (9) |
| 'Z' | 90 | 0x5A | 01011010 | ●○●○ (10) |

---

## 🎓 技术要点

### 1. 8051 UART 配置
```c
// 波特率 9600 @ 11.0592MHz
// 公式: TH1 = 256 - (FOSC / (32 * 12 * 波特率))
TH1 = 0xFD;  // 256 - 3 = 253
```

### 2. 按键去抖
```c
// 两次检测间隔 20ms
if (key_pressed) {
    delay(20ms);
    if (key_still_pressed) {
        return key_code;
    }
}
```

### 3. E49 模式
```
M1  M0  | 模式
----|----|-----------
0   0   | 透传模式 (UART直通)
0   1   | 唤醒模式
1   0   | 省电模式
1   1   | 配置模式
```

---

## ✅ 项目状态

- ✅ 遥控器代码完成
- ✅ 小车代码完成
- ✅ LED 调试功能完成
- ✅ 文档完整
- ⏳ 等待硬件测试
- ⏳ 等待按键映射确认

---

## 📝 备注

1. **晶振频率很重要**：
   - 11.0592MHz 适合串口 (无误差)
   - 12MHz 需要重新计算 TH1

2. **发送频率**：
   - 当前: 100ms 间隔 (10次/秒)
   - 可调: 50-200ms

3. **按键优先级**：
   - 方向键 > 速度键 > 功能键
   - 避免多键冲突

4. **功耗优化** (可选)：
   - 无按键时进入空闲模式
   - 降低扫描频率

---

**项目创建完成！等待编译器下载后即可烧录测试！** 🚀
