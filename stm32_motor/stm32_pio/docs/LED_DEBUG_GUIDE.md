# LED 调试指南

## 📌 概述

使用 4 个 LED（PB5, PB12, PB13, PB14）以**二进制编码**方式显示遥控器接收到的指令，方便调试无线通信。

---

## 🔌 硬件连接

### LED 引脚分配

| LED 位置 | GPIO 引脚 | 二进制位 | 说明 |
|---------|----------|---------|------|
| LED0    | **PB5**  | Bit 0 (LSB) | 最低位 |
| LED1    | **PB12** | Bit 1 | |
| LED2    | **PB13** | Bit 2 | |
| LED3    | **PB14** | Bit 3 (MSB) | 最高位 |

### 接线方式
```
STM32          LED
PB5   ------>  LED0 (+ 限流电阻) ----> GND
PB12  ------>  LED1 (+ 限流电阻) ----> GND
PB13  ------>  LED2 (+ 限流电阻) ----> GND
PB14  ------>  LED3 (+ 限流电阻) ----> GND
```

**注意**：
- LED 使用推挽输出，高电平点亮
- 建议使用 220Ω - 1kΩ 限流电阻
- 如果 LED 不亮，检查正负极是否接反

---

## 📊 指令编码表

### 遥控指令 → LED 显示

| 指令 | 功能 | 编码 | 二进制 | LED 显示 (PB14-PB13-PB12-PB5) |
|------|------|------|--------|-------------------------------|
| **F** | 前进 | 1 | 0001 | ○ ○ ○ ● |
| **B** | 后退 | 2 | 0010 | ○ ○ ● ○ |
| **L** | 左转 | 3 | 0011 | ○ ○ ● ● |
| **R** | 右转 | 4 | 0100 | ○ ● ○ ○ |
| **U** | 上（最大速度） | 5 | 0101 | ○ ● ○ ● |
| **D** | 下（保留） | 6 | 0110 | ○ ● ● ○ |
| **W** | 左上（前进+左转） | 7 | 0111 | ○ ● ● ● |
| **X** | 左下（后退+左转） | 8 | 1000 | ● ○ ○ ○ |
| **Y** | 右上（前进+右转） | 9 | 1001 | ● ○ ○ ● |
| **Z** | 右下（后退+右转） | 10 | 1010 | ● ○ ● ○ |
| **停止** | 超时/停止 | 0 | 0000 | ○ ○ ○ ○ (全灭) |
| **未知** | 无效指令 | 15 | 1111 | ● ● ● ● (全亮) |

**图例**：
- ● = LED 亮（高电平）
- ○ = LED 灭（低电平）

---

## 🧪 调试流程

### 1. 上电初始状态
```
LED 状态：全灭 (0000)
说明：系统就绪，等待遥控信号
```

### 2. 按下遥控器按键

#### 示例 1：按下 F（前进）
```
LED 状态：○ ○ ○ ● (0001)
说明：收到前进指令
小车动作：向前加速
```

#### 示例 2：按下 L（左转）
```
LED 状态：○ ○ ● ● (0011)
说明：收到左转指令
小车动作：原地左旋
```

#### 示例 3：按下 Y（右上 = 前进+右转）
```
LED 状态：● ○ ○ ● (1001)
说明：收到右上指令
小车动作：前进同时右转
```

### 3. 松开按键（超时）
```
LED 状态：○ ○ ○ ○ (0000)
说明：超时停止
小车动作：平滑减速停止
```

### 4. 收到无效数据
```
LED 状态：● ● ● ● (1111)
说明：收到未知指令或数据错误
小车动作：忽略该指令
```

---

## 🔍 故障排查

### 问题 1：LED 不亮
**可能原因**：
- LED 正负极接反
- 限流电阻过大（> 10kΩ）
- GPIO 引脚未正确初始化

**解决方法**：
1. 检查 LED 正负极
2. 更换限流电阻（推荐 220Ω）
3. 检查 `MX_GPIO_Init()` 是否被调用

---

### 问题 2：LED 一直全亮（1111）
**可能原因**：
- 遥控器发送的数据格式错误
- E49 模块未正确配置
- 串口波特率不匹配

**解决方法**：
1. 检查 E49 模块配置（透传模式，9600 波特率）
2. 检查 USART1 初始化
3. 使用串口监视器查看接收数据

---

### 问题 3：LED 一直全灭（0000）
**可能原因**：
- 未收到遥控信号
- E49 模块未配对
- 天线未连接

**解决方法**：
1. 检查 E49 模块电源
2. 检查天线连接
3. 确认遥控器与接收器在同一频道

---

### 问题 4：LED 闪烁不稳定
**可能原因**：
- 无线信号干扰
- 遥控器电量不足
- 超时时间设置过短

**解决方法**：
1. 远离 WiFi 路由器等 2.4GHz 设备
2. 更换遥控器电池
3. 增加超时时间（`setTimeout(1000)` → `setTimeout(1500)`）

---

## 📝 读取技巧

### 快速识别二进制

从右到左（PB5 → PB14）读取 LED 状态：

```
示例：● ○ ● ○
      ↑ ↑ ↑ ↑
     PB14 PB13 PB12 PB5
      8   0   2   0
      
计算：8 + 0 + 2 + 0 = 10
对应指令：Z (右下)
```

### 常用指令快速识别

**只有 1 个 LED 亮**：
- 最右边亮 (○○○●) = F (前进)
- 右2亮 (○○●○) = B (后退)
- 右3亮 (○●○○) = R (右转)
- 最左边亮 (●○○○) = X (左下)

**2 个 LED 亮**：
- 右边2个 (○○●●) = L (左转)
- 右1+右3 (○●○●) = U (上)
- 右2+右3 (○●●○) = D (下)
- 左+右 (●○○●) = Y (右上)
- 左+右2 (●○●○) = Z (右下)

**3 个 LED 亮**：
- 右边3个 (○●●●) = W (左上)

---

## 🎯 测试步骤

### 1. 基础测试
```cpp
// 在 main 中添加测试代码
setDebugLED(0);   // 全灭
HAL_Delay(500);
setDebugLED(15);  // 全亮
HAL_Delay(500);
setDebugLED(5);   // 0101
HAL_Delay(500);
setDebugLED(10);  // 1010
HAL_Delay(500);
```

### 2. 遥控器测试
1. 烧录固件
2. 按下遥控器各按键
3. 观察 LED 显示是否与编码表一致
4. 确认小车动作是否正确

### 3. 持续接收测试
1. 持续按住一个按键
2. 观察 LED 是否稳定显示
3. 松开按键，LED 应立即熄灭（超时后）

---

## 🔧 代码说明

### LED 控制函数
```c
void setDebugLED(uint8_t value);
```

**参数**：`value` = 0-15（4位二进制）

**实现**：
```c
void setDebugLED(uint8_t value)
{
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_5,  (value & 0x01) ? SET : RESET);
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_12, (value & 0x02) ? SET : RESET);
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_13, (value & 0x04) ? SET : RESET);
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_14, (value & 0x08) ? SET : RESET);
}
```

### 调用位置
1. **`RemoteControl::handleCommand()`**：接收到指令时更新 LED
2. **`RemoteControl::stop()`**：超时停止时熄灭 LED

---

## 📈 扩展应用

### 显示速度等级
可以修改代码显示当前速度等级（0-15）：

```cpp
// 在 handleCommand 中
int speedLevel = currentTargetStraightSpeed_ / 7;  // 0-14
setDebugLED(speedLevel);
```

### 显示系统状态
```cpp
// 0: 停止
// 1-5: 速度等级
// 6: 转向中
// 7: 加速中
// 8: 减速中
// 15: 错误
```

---

## ✅ 总结

LED 调试功能提供了：
- ✅ 实时可视化遥控指令
- ✅ 快速定位通信问题
- ✅ 无需串口监视器
- ✅ 4 位编码支持 16 种状态

**调试建议**：
1. 先测试 LED 硬件（全亮/全灭）
2. 再测试遥控器通信
3. 最后调试小车动作

祝调试顺利！🚗💨
