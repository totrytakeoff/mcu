# 蓝牙控制使用指南

## 📡 系统架构

本系统支持**双源遥控**，可同时使用无线遥控器和蓝牙控制：

```
┌─────────────────┐
│  E49 无线遥控器  │ ──USART1──┐
└─────────────────┘           │
                              ▼
┌─────────────────┐      ┌──────────────┐      ┌──────────────┐
│ ESP32-S3 蓝牙   │──────│ RemoteControl│──────│  DriveTrain  │
│  (手机APP)      │USART2│   (统一控制)  │      │ (差速转向)    │
└─────────────────┘      └──────────────┘      └──────────────┘
```

### 核心特性

✅ **双源共存**：无线遥控和蓝牙可同时工作，互不干扰  
✅ **统一控制**：两个输入源共享同一套运动控制逻辑  
✅ **双模式支持**：按键模式 + 摇杆模式  
✅ **平滑控制**：梯形速度轮廓，加减速平滑自然  
✅ **安全超时**：150ms 无信号自动停止

---

## 🔌 硬件连接

### ESP32-S3 与 STM32F103 连接

| ESP32-S3    | STM32F103 | 说明                |
| ----------- | --------- | ------------------- |
| GPIO17 (TX) | PA3 (RX)  | ESP32发送→STM32接收 |
| GPIO18 (RX) | PA2 (TX)  | ESP32接收←STM32发送 |
| GND         | GND       | 共地（必须连接）    |
| 3.3V        | 3.3V      | 电源（可选）        |

**注意事项**：
- ✅ 确保 GND 连接良好
- ✅ 两者都是 3.3V 逻辑，可直接连接
- ✅ 波特率：115200（已配置好）

---

## 📱 蓝牙控制协议

### 1️⃣ 按键模式（单字符命令）

**格式**：单个字母

| 命令 | 功能       | 说明                   |
| ---- | ---------- | ---------------------- |
| `F`  | 前进       | Forward                |
| `B`  | 后退       | Backward               |
| `L`  | 左转       | Left                   |
| `R`  | 右转       | Right                  |
| `W`  | 左前       | 前进 + 左转            |
| `Y`  | 右前       | 前进 + 右转            |
| `X`  | 左后       | 后退 + 左转            |
| `Z`  | 右后       | 后退 + 右转            |
| `U`  | 最大速度   | 直接跳到最大速度       |
| `S`  | 停止       | Stop（立即刹车）       |

**特性**：
- 📤 数据量：1 字节/命令
- ⏱️ 建议频率：100ms 重复发送
- 🚀 延迟：<50ms

**示例**：
```
手机APP发送: F F F F F ... (持续按住)
小车行为: 从基础速度25%逐步加速到80%
```

---

### 2️⃣ 摇杆模式（精确控制）

**格式**：`A[角度000-359]P[力度00-99]\n`

**参数说明**：
- **角度**：000-359 度（3位数字，前导0补齐）
  - `000°` = 正右（右转）
  - `090°` = 正上（前进）
  - `180°` = 正左（左转）
  - `270°` = 正下（后退）
  
- **力度**：00-99（2位数字，前导0补齐）
  - `00-04` = 停止（死区）
  - `05-99` = 对应速度百分比

**示例**：
```
A090P50\n  → 正上方向，50%力度（前进）
A000P99\n  → 正右方向，99%力度（右转）
A045P70\n  → 45度方向，70%力度（右前）
A180P30\n  → 正左方向，30%力度（左转）
A270P60\n  → 正下方向，60%力度（后退）
```

**角度映射**：
```
        090° (F)
         ↑
   135°  │  045°
    (W)  │  (Y)
         │
180°(L)──┼──000°(R)
         │
    (X)  │  (Z)
   225°  │  315°
         ↓
        270° (B)
```

**特性**：
- 📤 数据量：8 字节/命令
- ⏱️ 建议频率：50ms 重复发送
- 🚀 延迟：<50ms
- 🎯 精度：360个方向 × 100个力度档位

---

## 📲 手机APP使用

### 推荐APP

**Android**：
- [Serial Bluetooth Terminal](https://play.google.com/store/apps/details?id=de.kai_morich.serial_bluetooth_terminal)
- [nRF Connect](https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp)

**iOS**：
- [LightBlue](https://apps.apple.com/app/lightblue/id557428110)
- [nRF Connect](https://apps.apple.com/app/nrf-connect/id1054362403)

### 连接步骤

1. **启动系统**
   - 给 STM32 和 ESP32-S3 上电
   - ESP32-S3 自动开始 BLE 广播

2. **搜索设备**
   - 打开手机蓝牙
   - 打开 nRF Connect 或其他 BLE APP
   - 搜索设备：`ESP32-S3-UART`

3. **连接设备**
   - 点击 `ESP32-S3-UART` 连接
   - 找到 **Nordic UART Service**
   - 启用 **TX 特征的通知**

4. **发送命令**
   - 在 **RX 特征** 中写入命令
   - 按键模式：直接发送 `F` / `B` / `L` / `R` 等
   - 摇杆模式：发送 `A090P50\n` 等格式

---

## ⚙️ 参数配置

### 当前优化参数（已调优）

```cpp
// 速度参数
remoteControl.setBaseSpeed(25);          // 基础速度 25%
remoteControl.setMaxSpeed(80);           // 最高速度 80%
remoteControl.setSpeedIncrement(3);      // 速度增量 3%
remoteControl.setTurnSensitivity(35);    // 转向灵敏度 35%
remoteControl.setTimeout(150);           // 超时 150ms

// 加速度参数
driveTrain.setAcceleration(
    8,   // 加速度
    15,  // 减速度
    20   // 反向减速度
);
```

### 参数调整建议

| 问题               | 调整参数                | 方向   |
| ------------------ | ----------------------- | ------ |
| 起步太猛           | `baseSpeed`             | 降低   |
| 加速太快           | `speedIncrement`        | 降低   |
| 最高速度太快       | `maxSpeed`              | 降低   |
| 转向不够灵敏       | `turnSensitivity`       | 提高   |
| 转向太激进         | `turnSensitivity`       | 降低   |
| 松开后刹车太慢     | `driveTrain` 减速度     | 提高   |
| 松开后刹车太急     | `driveTrain` 减速度     | 降低   |
| 方向切换不够快     | `driveTrain` 反向减速度 | 提高   |
| 停止响应慢         | `setTimeout`            | 降低   |

---

## 🧪 测试方法

### 1. 按键模式测试

使用 **Serial Bluetooth Terminal** 或 **nRF Connect**：

```
发送: F
预期: 小车以 25% 速度前进

持续发送: F F F F F ...
预期: 小车逐步加速到 80%

停止发送
预期: 150ms 后小车自动减速停止

发送: B
预期: 小车立即刹停，然后反向加速
```

### 2. 摇杆模式测试

```
发送: A090P50\n
预期: 小车前进（50%力度）

发送: A000P70\n
预期: 小车右转（70%力度）

发送: A045P60\n
预期: 小车右前方向移动（60%力度）

发送: A000P00\n
预期: 小车停止
```

### 3. 双源共存测试

```
1. 使用无线遥控器按下 F
   → 小车前进

2. 同时使用蓝牙发送 L
   → 小车响应最后一个指令（左转）

3. 两个源交替控制
   → 小车正常响应，无冲突
```

---

## 🐛 故障排除

### 问题 1: 找不到蓝牙设备

**可能原因**：
- ESP32-S3 未上电
- ESP32-S3 固件未烧录
- 手机蓝牙未开启

**解决方法**：
1. 检查 ESP32-S3 电源指示灯
2. 重新烧录 ESP32-S3 固件
3. 重启手机蓝牙

---

### 问题 2: 连接后立即断开

**可能原因**：
- 电源不稳定
- 距离太远

**解决方法**：
1. 检查电源供电是否稳定
2. 靠近设备（<5米）
3. 重启 ESP32-S3

---

### 问题 3: 小车不响应蓝牙命令

**可能原因**：
- USART2 连接错误
- 波特率不匹配
- 固件未更新

**检查步骤**：
1. 确认硬件连接：
   ```
   ESP32 TX (GPIO17) → STM32 RX (PA3)
   ESP32 RX (GPIO18) → STM32 TX (PA2)
   GND → GND
   ```

2. 确认波特率：
   - ESP32-S3: 115200（固件中配置）
   - STM32 USART2: 115200（已配置）

3. 重新烧录 STM32 固件：
   ```bash
   cd stm32_pio
   pio run -t upload
   ```

---

### 问题 4: 摇杆模式不工作

**可能原因**：
- 数据格式错误
- 换行符缺失

**解决方法**：
1. 确保格式正确：`A090P50\n`
2. 必须以 `\n` 或 `\r` 结尾
3. 角度必须是 3 位数字（前导0）
4. 力度必须是 2 位数字（前导0）

**正确示例**：
```
✅ A090P50\n
✅ A000P99\n
✅ A180P05\n

❌ A90P50\n    (角度缺少前导0)
❌ A090P5\n    (力度缺少前导0)
❌ A090P50     (缺少换行符)
```

---

### 问题 5: 小车响应延迟

**可能原因**：
- 蓝牙发送频率太低
- 超时设置太长

**解决方法**：
1. 提高发送频率：
   - 按键模式：100ms 重复
   - 摇杆模式：50ms 重复

2. 调整超时参数：
   ```cpp
   remoteControl.setTimeout(100);  // 降低到100ms
   ```

---

## 📊 性能参数

| 参数           | 数值       | 说明                   |
| -------------- | ---------- | ---------------------- |
| 蓝牙传输速率   | 20-30KB/s  | BLE 典型速率           |
| UART 波特率    | 115200     | STM32 ↔ ESP32          |
| 控制延迟       | <50ms      | 从发送到执行           |
| 超时时间       | 150ms      | 无信号自动停止         |
| 最大连接距离   | 约10米     | 空旷环境               |
| 加速时间       | 约2-3秒    | 从0到最大速度          |
| 刹车时间       | 约1-2秒    | 从最大速度到停止       |

---

## 🔧 高级定制

### 1. 修改摇杆角度映射

编辑 `bluetooth_control.cpp` 中的 `convertJoystickToMotion()` 函数：

```cpp
// 当前：每45度一个区域
// 可改为：每30度一个区域（更精细）
if (angle >= 345 || angle < 15) {
    command = 'R';  // 0° ± 15°
}
```

### 2. 添加力度精确控制

扩展 `RemoteControl` 类，添加直接速度设置接口：

```cpp
// 在 RemoteControl 中添加
void setDirectSpeed(int straightSpeed, int turnSpeed);

// 在 BluetoothControl 中调用
remoteControl_.setDirectSpeed(power, 0);
```

### 3. 添加更多自定义命令

在 `handleKeyCommand()` 中添加：

```cpp
case 'H':  // Horn（喇叭）
    // 触发蜂鸣器
    break;

case 'M':  // Mode（模式切换）
    // 切换控制模式
    break;
```

---

## 📚 相关文档

- [LED_DEBUG_GUIDE.md](LED_DEBUG_GUIDE.md) - LED调试指南
- [ESP32-S3 固件文档](../../esp32_pio/README.md) - ESP32端配置
- [遥控器固件文档](../../remote_control_pio/README.md) - 无线遥控器

---

## 🎯 快速参考

### 常用命令速查

```
按键模式:
F - 前进    B - 后退
L - 左转    R - 右转
W - 左前    Y - 右前
X - 左后    Z - 右后
S - 停止    U - 最大速度

摇杆模式:
A090P50\n - 前进50%
A000P70\n - 右转70%
A180P60\n - 左转60%
A270P40\n - 后退40%
```

### 调试技巧

1. **LED指示**：观察 PB5/12/13/14 的LED显示接收到的命令
2. **串口监视**：ESP32-S3 的 USB 口可查看透传数据
3. **逐步测试**：先测试按键模式，再测试摇杆模式

---

**版本**: v1.0  
**更新日期**: 2025-10-11  
**作者**: AI Assistant
