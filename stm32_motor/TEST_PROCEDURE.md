# STM32 电机驱动分步测试流程

## 问题现状
- 使用修复后的代码，电机仍然无反应
- 需要从最底层开始逐步排查

---

## 测试步骤（按顺序执行）

### 测试 1: GPIO 基本输出测试 ⭐ **从这里开始**

**目的**: 验证 PC6 引脚能否正常输出高低电平

**测试文件**: `USER/main_test_simple.c`

**操作步骤**:
1. 在 Keil 工程中，**临时**把 `main.c` 替换为 `main_test_simple.c`（或直接修改 uvprojx 的文件列表）
2. 编译并烧录
3. 用万用表测量 PC6 引脚（相对 GND）

**预期结果**:
- 电压在 0V 和 3.3V 之间每秒切换一次
- 能看到明显的电压变化

**如果失败**:
- 检查 GPIOC 时钟是否使能
- 检查引脚是否被其他外设占用
- 检查硬件连接（PC6 是否短路/断路）

---

### 测试 2: 50Hz PWM 信号测试（低有效）

**目的**: 验证能否产生标准的 50Hz 控制信号（与 Arduino 一致）

**测试文件**: `USER/main_test_pwm.c`

**操作步骤**:
1. 替换为 `main_test_pwm.c`
2. 编译并烧录
3. 用示波器测量 PC6（如果没有示波器，用万用表看平均电压应约 3.0V）

**预期结果**:
- 默认 3.3V
- 每 20ms 有一次 1.5ms 的低电平脉冲
- 占空比约 92.5%（18.5ms 高 / 20ms 总）

**如果电机还不转**:
- 信号本身正确，问题可能在极性或电调兼容性
- 继续测试 3

---

### 测试 3: 极性反转测试（高有效）⭐ **关键测试**

**目的**: 测试反向极性（默认低，高电平脉冲）

**测试文件**: `USER/main_test_inverted.c`

**操作步骤**:
1. 替换为 `main_test_inverted.c`
2. 编译并烧录
3. 观察电机反应

**预期结果**:
- 如果这个版本电机能转，说明**需要反转信号极性**
- 如果还是不转，继续排查

---

### 测试 4: 尝试不同脉宽（如果测试 2 或 3 有反应）

修改 `delay_us_rough(1500)` 为不同值：
- `1000` - 最小值（正转最大/反转最大）
- `1500` - 中位（停止）
- `2000` - 最大值（正转最大/反转最大）

观察电机反应变化。

---

## 如何替换 main.c

### 方法 1: 直接重命名（推荐）
```bash
# 备份原文件
ren USER\main.c main_backup.c

# 复制测试文件
copy USER\main_test_simple.c USER\main.c
```

### 方法 2: 在 Keil 中修改
1. 右键工程中的 `main.c` → Remove
2. 右键 USER 组 → Add Existing Files → 选择 `main_test_simple.c`
3. 编译

---

## 关键检查点

### 硬件连接（必须确认）
```
STM32 PC6 ──→ 电调 SIG
STM32 GND ──→ 电调 GND    ← 必须共地！
电调 12V  ──→ 外部电源
```

### 电调类型确认
查看 MDA12E11-830 的说明书：
- [ ] 信号电压范围：3.3V 还是 5V？
- [ ] 信号极性：高有效还是低有效？
- [ ] 脉宽范围：标准 1000~2000µs 吗？
- [ ] 是否需要上电校准序列？

### 可能的兼容性问题
1. **3.3V vs 5V**: 
   - Arduino Uno 输出 5V，STM32 输出 3.3V
   - 有些电调可能需要 5V 逻辑电平
   - **解决**: 加一个电平转换电路（如 74LVC245）

2. **反相驱动**:
   - 开发板上可能有反相器/驱动芯片
   - 导致 STM32 输出被反转
   - **解决**: 使用 `main_test_inverted.c` 测试

3. **电流不足**:
   - STM32 GPIO 驱动能力约 20mA
   - 如果信号线上有下拉电阻，可能拉不动
   - **解决**: 使用推挽输出（已设置）或外加缓冲器

---

## 调试检查清单

- [ ] 测试 1 通过（GPIO 能输出高低电平）
- [ ] 测试 2 完成（标准低有效脉冲）
- [ ] 测试 3 完成（反向高有效脉冲）
- [ ] 用示波器确认波形正确
- [ ] 确认 GND 共地
- [ ] 确认 12V 供电正常
- [ ] 查阅电调说明书确认信号要求

---

## 如果所有测试都失败

### 可能原因
1. **引脚定义错误**: PC6 不是实际的电机控制口
2. **板载电路**: 开发板上有额外的控制电路需要使能
3. **电调故障**: 用 Arduino 再次验证电调是否正常
4. **供电问题**: 12V 电源功率不足或接触不良

### 下一步
1. 提供开发板的详细型号和原理图
2. 用示波器截图 PC6 的实际波形
3. 用 Arduino 测试同一个电调，确认硬件正常
4. 检查是否有 LED 或其他指示灯反馈

---

## 成功后如何恢复正常代码

找到能工作的版本后：
1. 记录极性（低有效还是高有效）
2. 记录延时精度要求
3. 修改原 `main.c` 的极性定义或宏
4. 重新测试完整功能（正转/反转/停止）

---

## 联系支持

如果完成所有测试仍无法工作，请提供：
1. 测试 1/2/3 的结果（电机/LED 有无反应）
2. 示波器波形截图（如有）
3. 开发板型号和电调型号
4. 用 Arduino 驱动时的接线照片
