# 抛物线拟合巡线算法测试工具使用指南

## 📋 概述

本工具集提供了三种方式来可视化和测试您的8点抛物线拟合巡线算法，**完全一比一复刻**STM32代码中的实现逻辑。

---

## 🎯 工具清单

### 1. **Web可视化工具** (推荐) ⭐
   - 文件: `parabolic_web_visualizer.html`
   - 特点: 交互式Web界面，无需安装Python
   - 适用: 快速测试和演示

### 2. **Python图形化工具**
   - 文件: `parabolic_line_visualizer.py`
   - 特点: Matplotlib可视化，详细参数显示
   - 适用: 深入分析和调试

### 3. **命令行测试工具**
   - 文件: `test_parabolic_algorithm.py`
   - 特点: 批量测试，支持从temp.txt加载数据
   - 适用: 自动化测试和大量数据验证

---

## 🚀 快速开始

### 方法1: Web工具（最简单）

1. **打开HTML文件**
   ```bash
   # 直接用浏览器打开
   parabolic_web_visualizer.html
   ```

2. **操作步骤**
   - 在输入框输入8个传感器值（空格分隔）
   - 点击"计算位置"按钮
   - 点击"黑底白线/白底黑线"切换模式
   - 点击预设按钮快速测试不同场景

3. **观察内容**
   - 🎯 **位置显示**: 大号显示计算出的位置值和可视化指示器
   - 📊 **峰值检测**: 峰值索引、位置、预处理后的值
   - 🎯 **拟合计算**: 方法、分母、偏移量
   - 🔢 **三点数据**: y0(左)、y1(中)、y2(右)
   - 📐 **位置计算**: 基准位置、偏移修正、最终位置
   - 📈 **图表**: 原始数据曲线图 + 预处理后的柱状图

---

### 方法2: Python图形化工具

1. **安装依赖**
   ```bash
   pip install numpy matplotlib
   ```

2. **运行工具**
   ```bash
   python parabolic_line_visualizer.py
   ```

3. **操作说明**
   - 在底部输入框输入8个传感器值
   - 按Enter确认
   - 点击右下角按钮切换线模式

4. **图形说明**
   - **图1（上）**: 原始ADC值 + 预处理值 + 抛物线拟合曲线 + 计算位置
   - **图2（左下）**: 预处理后的柱状图（红色=峰值，橙边=拟合点）
   - **图3（右下）**: 详细计算参数文本显示

---

### 方法3: 命令行工具

1. **安装依赖**
   ```bash
   pip install numpy
   ```

2. **运行工具**
   ```bash
   python test_parabolic_algorithm.py
   ```

3. **选择测试模式**
   ```
   请选择测试模式:
     1. 批量测试（使用temp.txt中的数据）
     2. 交互式测试（手动输入数据）
     3. 快速测试（预置的几组典型数据）
   ```

4. **模式说明**

   **模式1 - 批量测试**
   - 自动读取 `src/temp.txt` 中的所有SENSOR_DATA数据
   - 按分类（纯黑底、纯白底、跨白线、居中）分组测试
   - 每组显示前3个样本的详细计算过程

   **模式2 - 交互式测试**
   - 手动输入传感器数据
   - 选择线模式（黑底白线/白底黑线）
   - 实时显示详细计算步骤
   - 输入 'q' 退出

   **模式3 - 快速测试**
   - 使用预置的5组典型数据
   - 自动测试并显示结果

---

## 📊 测试数据示例

### 从 `src/temp.txt` 提取的典型数据

```
居中位置:  1469 1064 716 332 346 604 998 1344
纯黑底:    1597 1541 1547 1497 1510 1525 1550 1584
纯白底:    566 402 293 263 281 355 479 717
跨白线-1:  1214 1029 973 861 897 962 1013 1148
跨白线-2:  962 770 690 613 638 685 732 918
```

### 自定义测试数据

```
偏左:      1000 500 300 280 1200 1400 1500 1600
偏右:      1600 1500 1400 1200 280 300 500 1000
极左边界:  200 300 400 500 1500 1600 1700 1800
极右边界:  1800 1700 1600 1500 500 400 300 200
```

---

## 🔍 关键信息解读

### 1. 峰值检测
- **峰值索引**: 预处理后值最大的传感器编号(0-7)
- **峰值位置**: 该传感器对应的位置(-1000到+1000)
- **峰值值**: 预处理后的最大值

### 2. 拟合方法
- **三点拟合**: 正常情况，使用峰值及左右相邻点
- **左边界处理**: 峰值在索引0，构造虚拟左邻点
- **右边界处理**: 峰值在索引7，构造虚拟右邻点
- **加权平均**: 分母接近0时退化使用

### 3. 计算参数
- **y0, y1, y2**: 拟合使用的三个点的预处理后的值
- **分母 (denominator)**: `2 × (y0 - 2×y1 + y2)`
- **偏移量 (offset)**: `(y0 - y2) / denominator`，范围 [-1, 1]

### 4. 位置计算
```
最终位置 = 峰值传感器位置 + 偏移量 × 传感器间距(286)
```

例如：
```
峰值索引 = 3，峰值位置 = -142.0
偏移量 = 0.4648
最终位置 = -142.0 + 0.4648 × 286.0 = -9.06
```

---

## 🎨 算法核心逻辑（完全复刻）

### 常量定义
```python
SENSOR_POSITIONS = [-1000.0, -714.0, -428.0, -142.0, 
                    142.0, 428.0, 714.0, 1000.0]
SENSOR_SPACING = 286.0
ADC_MAX = 4095.0
```

### 处理流程

```
1. 数据预处理
   ├─ 黑底白线: values[i] = 4095 - sensor_data[i]
   └─ 白底黑线: values[i] = sensor_data[i]

2. 峰值检测
   └─ 找到values中最大值的索引

3. 边界处理
   ├─ peak_idx == 0: 构造虚拟左邻点
   ├─ peak_idx == 7: 构造虚拟右邻点
   └─ 其他: 进入三点拟合

4. 三点抛物线拟合
   ├─ y0 = values[peak_idx - 1]
   ├─ y1 = values[peak_idx]
   ├─ y2 = values[peak_idx + 1]
   ├─ denominator = 2 × (y0 - 2×y1 + y2)
   └─ offset = (y0 - y2) / denominator

5. 计算最终位置
   └─ position = SENSOR_POSITIONS[peak_idx] + offset × 286.0

6. 限幅
   └─ position = clip(position, -1000.0, 1000.0)
```

---

## 🧪 测试建议

### 1. 基础功能测试
- [ ] 居中数据: 位置应接近0
- [ ] 纯黑底数据: 位置应稳定在某个值附近
- [ ] 纯白底数据: 位置应稳定在某个值附近

### 2. 边界测试
- [ ] 峰值在索引0: 测试左边界处理逻辑
- [ ] 峰值在索引7: 测试右边界处理逻辑
- [ ] 极端偏移: 检查是否正确限幅到±1000

### 3. 精度测试
- [ ] 跨白线数据: 位置应连续变化，无跳变
- [ ] 对称数据: 左右对称的数据位置应对称
- [ ] 小偏移: 微小的传感器值变化能否反映到位置

### 4. 模式测试
- [ ] 黑底白线模式: 白线处值低，应反转处理
- [ ] 白底黑线模式: 黑线处值高，直接使用

---

## 📈 结果判断标准

### ✅ 算法准确的表现
1. **居中数据**: 位置在 -50 到 +50 之间
2. **连续性**: 传感器值连续变化时，位置平滑过渡
3. **对称性**: 左右对称的数据产生对称的位置
4. **边界处理**: 边界情况不会直接跳到±1000

### ⚠️ 可能的问题指标
1. **位置跳变**: 相邻数据位置差异超过500
2. **居中偏移**: 明显居中的数据位置偏离0超过200
3. **反向**: 线明显向左移动，位置却增大（或相反）
4. **边界异常**: 边界处理导致位置不合理

---

## 🐛 常见问题

### Q1: Python工具运行报错？
**A**: 检查是否安装了依赖：
```bash
pip install numpy matplotlib
```

### Q2: Web工具图表不显示？
**A**: 确保网络连接正常（需要加载Chart.js），或下载离线版Chart.js。

### Q3: 计算结果和STM32不一致？
**A**: 检查：
- 传感器数据是否完全一致
- 线模式是否选择正确（黑底白线/白底黑线）
- STM32代码中的常量定义是否与工具一致

### Q4: 如何批量测试temp.txt中的所有数据？
**A**: 使用命令行工具的模式1：
```bash
python test_parabolic_algorithm.py
# 选择: 1
```

### Q5: 想看某个特定数据的详细计算过程？
**A**: 推荐使用：
1. Web工具 - 直观可视化
2. Python图形化工具 - 更详细的参数
3. 命令行交互模式 - 文本输出

---

## 📝 输出示例

### 命令行工具输出示例

```
第 1 组:
  原始数据: [1469, 1064, 716, 332, 346, 604, 998, 1344]
  预处理后: [2626, 3031, 3379, 3763, 3749, 3491, 3097, 2751]
  峰值索引: 3, 峰值: 3763.0, 位置: -142.0
  【三点拟合】y0=3379.0 [idx=2], y1=3763.0 [idx=3], y2=3749.0 [idx=4]
  分母: 2×(3379.0 - 2×3763.0 + 3749.0) = -796.0000
  偏移: (3379.0 - 3749.0) / -796.0000 = 0.4648
  最终位置: -142.0 + 0.4648 × 286.0 = -9.06
  ═══> 结果: -9.06
```

---

## 🎓 使用技巧

### 1. 快速验证算法
使用Web工具 + 预设按钮，一键测试各种场景

### 2. 深入分析问题
使用Python图形化工具，观察抛物线拟合曲线

### 3. 批量回归测试
使用命令行工具批量测试temp.txt中的所有数据

### 4. 对比STM32输出
将STM32串口输出的SENSOR_DATA直接粘贴到工具中测试

### 5. 调试边界情况
手动构造峰值在0或7的数据，验证边界处理逻辑

---

## 🔧 自定义扩展

### 修改传感器位置
在代码中修改常量：
```python
SENSOR_POSITIONS = [你的位置数组]
SENSOR_SPACING = 你的间距
```

### 修改ADC范围
```python
ADC_MAX = 你的ADC最大值
```

### 添加新的预设数据
在Web工具中：
```javascript
const presets = [
    [你的数据1],
    [你的数据2],
    // ...
];
```

---

## 📞 技术支持

如果发现工具与STM32代码行为不一致，请检查：
1. STM32代码版本
2. 常量定义是否匹配
3. 浮点运算精度差异（通常可忽略）

---

## ⚡ 性能说明

- **Web工具**: 实时计算，无延迟
- **Python图形化**: 初始加载需1-2秒，计算实时
- **命令行工具**: 批量测试1000组数据约1秒

---

## 🎉 总结

这套工具完全复刻了您的STM32抛物线拟合算法，提供了：
- ✅ **三种使用方式**：Web/图形化/命令行
- ✅ **详细的计算过程**：每一步都可追溯
- ✅ **可视化展示**：图表直观显示数据和结果
- ✅ **批量测试能力**：支持temp.txt中的所有数据
- ✅ **灵活的数据输入**：手动输入或预设数据

**推荐工作流程**：
1. 用Web工具快速测试和演示
2. 用Python工具深入分析问题数据
3. 用命令行工具进行批量验证

祝测试顺利！🚀
