# 动态缩放完全使用指南

## 🎯 核心思想

**问题**：你发现的问题非常准确！
- 小偏差时：转向过猛 → 导致过调 → 跑偏
- 大偏差时：转向不足 → 无法快速回正

**解决方案**：完全动态的缩放算法
```
位置偏差越小 → 缩放系数越小 → 转向越温和
位置偏差越大 → 缩放系数越大 → 转向越激进
```

---

## 📊 动态缩放工作原理

### 算法流程

```
1. 读取位置偏差：error = -500（线在左侧）

2. 归一化：normalized = 500 / 1000 = 0.5

3. 应用曲线函数：
   - LINEAR: factor = 0.5
   - QUADRATIC: factor = 0.5² = 0.25
   - SQRT: factor = √0.5 = 0.707
   - CUBIC: factor = 0.5³ = 0.125

4. 计算缩放系数：
   scale = 0.03 + (0.15 - 0.03) × factor
   
   LINEAR: scale = 0.03 + 0.12 × 0.5 = 0.09
   QUADRATIC: scale = 0.03 + 0.12 × 0.25 = 0.06
   SQRT: scale = 0.03 + 0.12 × 0.707 = 0.115
   CUBIC: scale = 0.03 + 0.12 × 0.125 = 0.045

5. 应用到PID输出：
   final_output = raw_pid × scale
```

### 实际效果对比

| 位置偏差 | LINEAR | QUADRATIC | SQRT | CUBIC |
|---------|--------|-----------|------|-------|
| **100** (微调) | 3% | 1% | 5% | 0.4% |
| **300** (小偏) | 9% | 2.7% | 10.5% | 1.1% |
| **500** (中偏) | 9% | 6% | 11.5% | 4.5% |
| **700** (大偏) | 12.3% | 10.9% | 13% | 10.3% |
| **1000** (最大) | 15% | 15% | 15% | 15% |

---

## 🔧 使用方法

### 方法1：使用默认配置（推荐初次使用）

系统已经配置了合理的默认值：

```cpp
// 默认配置（已在代码中）：
// - 动态缩放：启用
// - 小偏差缩放：0.03（非常温和）
// - 大偏差缩放：0.15（中等激进）
// - 曲线类型：LINEAR（线性）

// 无需额外配置，直接运行即可！
```

### 方法2：自定义配置

在 `main.cpp` 初始化部分添加：

```cpp
/* ========== 12. 初始化巡线控制器 ========== */
LineFollower line_follower(line_sensor, drive_train);

// 基础配置
line_follower.setPID(0.08f, 0.0f, 1.5f);
line_follower.setSpeed(15);

// 动态缩放配置
line_follower.enableDynamicScale(true);              // 启用动态缩放
line_follower.setDynamicScaleRange(0.03f, 0.15f);   // 设置范围
line_follower.setScaleCurve(LineFollower::ScaleCurve::LINEAR);  // 曲线类型

line_follower.enableDebug(true);
```

---

## 📈 四种曲线类型详解

### 1. LINEAR（线性）- 推荐

**特点**：均匀响应，简单可靠

**数学**：`scale = min + (max - min) × (error / 1000)`

**曲线图**：
```
Scale
  |
0.15 |                    ╱
     |                 ╱
0.12 |              ╱
     |           ╱
0.09 |        ╱
     |     ╱
0.06 |  ╱
     |╱
0.03 +─────────────────────> Error
     0   250   500   750  1000
```

**适用**：
- ✅ 初次调试
- ✅ 大部分场景
- ✅ 可预测的行为

**设置**：
```cpp
line_follower.setScaleCurve(LineFollower::ScaleCurve::LINEAR);
```

---

### 2. QUADRATIC（二次方）

**特点**：小偏差超温和，大偏差激进

**数学**：`factor = (error / 1000)²`

**曲线图**：
```
Scale
  |
0.15 |                      ╱
     |                    ╱
0.12 |                  ╱
     |                ╱
0.09 |             ╱
     |          ╱
0.06 |      ╱
     |   ╱
0.03 +─────────────────────> Error
     0   250   500   750  1000
     ↑温和        ↑激进
```

**适用**：
- ✅ **解决你的问题最好的选择**
- ✅ 需要精细微调
- ✅ 避免小偏差过调

**设置**：
```cpp
line_follower.setScaleCurve(LineFollower::ScaleCurve::QUADRATIC);
```

---

### 3. SQRT（平方根）

**特点**：小偏差激进，大偏差温和

**数学**：`factor = √(error / 1000)`

**曲线图**：
```
Scale
  |
0.15 |          ╱─────────
     |       ╱
0.12 |     ╱
     |   ╱
0.09 | ╱
     |╱
0.06 ╱
     |
0.03 +─────────────────────> Error
     0   250   500   750  1000
     ↑激进        ↑温和
```

**适用**：
- ⚠️ 需要快速响应
- ⚠️ 但要避免大偏差过冲

**设置**：
```cpp
line_follower.setScaleCurve(LineFollower::ScaleCurve::SQRT);
```

---

### 4. CUBIC（三次方）

**特点**：小偏差极温和，大偏差极激进

**数学**：`factor = (error / 1000)³`

**曲线图**：
```
Scale
  |
0.15 |                       ╱
     |                      │
0.12 |                    ╱
     |                  ╱
0.09 |               ╱
     |            ╱
0.06 |        ╱
     |    ╱
0.03 +─────────────────────> Error
     0   250   500   750  1000
     ↑极温和      ↑极激进
```

**适用**：
- ⚠️ 极端精细控制
- ⚠️ 慎用

**设置**：
```cpp
line_follower.setScaleCurve(LineFollower::ScaleCurve::CUBIC);
```

---

## 🎯 推荐配置方案

### 方案1：解决你当前问题（推荐）

```cpp
// 针对"微调跑偏、大偏调不回"的问题
line_follower.enableDynamicScale(true);
line_follower.setDynamicScaleRange(0.02f, 0.18f);  // 更大的范围差
line_follower.setScaleCurve(LineFollower::ScaleCurve::QUADRATIC);  // 二次方曲线
line_follower.setPID(0.08f, 0.0f, 1.5f);
line_follower.setSpeed(15);
```

**效果**：
- 小偏差（<300）：极温和，scale约0.02-0.05
- 大偏差（>600）：激进，scale约0.12-0.18

---

### 方案2：保守配置

```cpp
// 平稳优先
line_follower.enableDynamicScale(true);
line_follower.setDynamicScaleRange(0.03f, 0.12f);
line_follower.setScaleCurve(LineFollower::ScaleCurve::LINEAR);
line_follower.setPID(0.06f, 0.0f, 1.0f);
line_follower.setSpeed(20);
```

---

### 方案3：快速响应

```cpp
// 竞速配置
line_follower.enableDynamicScale(true);
line_follower.setDynamicScaleRange(0.05f, 0.25f);
line_follower.setScaleCurve(LineFollower::ScaleCurve::LINEAR);
line_follower.setPID(0.10f, 0.0f, 2.0f);
line_follower.setSpeed(35);
```

---

## 🔬 调试技巧

### 1. 观察Scale值

新的调试输出：
```
Pos:150 Err:150 RawPID:9 Scale:4 PID:0 Spd:15 | S:...
                          ↑
                    Scale=4 表示4%=0.04
```

**分析**：
- Pos小时Scale小 → 说明动态缩放工作正常
- Pos大时Scale大 → 确认激进响应

### 2. 对比不同曲线

```cpp
// 测试1：线性
line_follower.setScaleCurve(LineFollower::ScaleCurve::LINEAR);
// 跑几圈，观察行为

// 测试2：二次方
line_follower.setScaleCurve(LineFollower::ScaleCurve::QUADRATIC);
// 再跑几圈，对比

// 选择表现最好的
```

### 3. 微调范围

```cpp
// 如果小偏差还是过调
line_follower.setDynamicScaleRange(0.01f, 0.15f);  // 减小min

// 如果大偏差回正慢
line_follower.setDynamicScaleRange(0.03f, 0.20f);  // 增大max
```

---

## 📊 完整参数对照表

| 参数 | 范围 | 默认值 | 说明 |
|------|------|--------|------|
| `enableDynamicScale` | true/false | true | 是否启用动态缩放 |
| `small_error_scale` | 0.01-0.10 | 0.03 | 小偏差缩放系数 |
| `large_error_scale` | 0.10-0.30 | 0.15 | 大偏差缩放系数 |
| `ScaleCurve` | 4种 | LINEAR | 曲线类型 |

---

## 🚀 快速开始

### 步骤1：使用推荐配置

在 `main.cpp` 第125行附近添加：

```cpp
// 解决微调过调、大偏不足的问题
line_follower.setScaleCurve(LineFollower::ScaleCurve::QUADRATIC);
line_follower.setDynamicScaleRange(0.02f, 0.18f);
line_follower.setSpeed(15);
```

### 步骤2：编译上传

```bash
platformio run -t upload
```

### 步骤3：观察效果

观察调试输出中的 `Scale` 值：
- 居中时（Pos<100）：Scale应该很小（1-3）
- 偏离时（Pos>500）：Scale应该变大（10-18）

### 步骤4：微调

根据实际效果调整：
- 还是过调 → 减小 `small_error_scale` 到 0.01
- 回正太慢 → 增大 `large_error_scale` 到 0.20

---

## ⚡ 常见问题

### Q: 动态缩放和固定缩放有什么区别？

**固定缩放**（旧方式）：
```
所有偏差都用相同的scale
Pos=50:  scale=0.10 → 可能太大，过调
Pos=800: scale=0.10 → 可能太小，回正慢
```

**动态缩放**（新方式）：
```
根据偏差大小自动调整
Pos=50:  scale=0.025 → 温和，避免过调 ✅
Pos=800: scale=0.145 → 激进，快速回正 ✅
```

### Q: 应该选哪种曲线？

**建议顺序**：
1. 先试 `QUADRATIC`（二次方）← 最适合你的问题
2. 如果太温和，试 `LINEAR`（线性）
3. 如果还不满意，再试其他

### Q: 参数范围如何设置？

**经验法则**：
```cpp
// small_error_scale：越小越温和
0.01 - 极温和（可能太慢）
0.02 - 很温和（推荐）
0.03 - 温和（默认）
0.05 - 中等

// large_error_scale：越大越激进
0.12 - 温和
0.15 - 中等（默认）
0.18 - 激进（推荐）
0.20 - 很激进
0.25 - 极激进（慎用）
```

---

## 🎉 总结

### 核心改进

1. ✅ **完全动态**：根据每个pos值实时计算scale
2. ✅ **平滑过渡**：连续函数，无跳变
3. ✅ **多种曲线**：4种曲线适应不同需求
4. ✅ **解决过调**：小偏差温和控制
5. ✅ **快速回正**：大偏差激进响应
6. ✅ **丢线改进**：温和搜索，不再猛转

### 立即行动

```cpp
// 在main.cpp添加这三行，解决你的问题！
line_follower.setScaleCurve(LineFollower::ScaleCurve::QUADRATIC);
line_follower.setDynamicScaleRange(0.02f, 0.18f);
line_follower.setSpeed(15);
```

**现在动态缩放是完全根据位置连续计算的，不再是死的分段了！** 🎯
