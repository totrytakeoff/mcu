# PID参数调试完全指南

## 🎯 调试前准备

### 1. 确认硬件正常
- [ ] 传感器已校准（长按PD2按钮3秒）
- [ ] 电机工作正常
- [ ] 小车放在黑底白线上
- [ ] 启用调试输出：`line_follower.enableDebug(true)`

### 2. 理解调试输出

```
Pos:150 Err:150 PID:9 | S:1387 1124 784 375 481 658 962 1587
 ↓      ↓      ↓        ↓
位置    误差   PID输出   8个传感器原始数据
```

#### 位置值（Pos）含义
- **-1000 到 -500**：线在左侧很多，需要大幅左转
- **-500 到 -200**：线偏左，需要左转
- **-200 到 +200**：线接近中心，直行或微调
- **+200 到 +500**：线偏右，需要右转
- **+500 到 +1000**：线在右侧很多，需要大幅右转

#### PID输出含义
- **负值（-100 到 0）**：向右转（右轮减速）
- **0**：直行
- **正值（0 到 +100）**：向左转（左轮减速）

---

## 📊 参数调试步骤

### 第一步：只调P参数（Kp）

**目标**：让小车能够跟随黑线，允许有震荡

```cpp
// 设置初始参数
line_follower.setPID(0.03f, 0.0f, 0.0f);  // 只有P，从小值开始
line_follower.setSpeed(20);  // 低速测试
```

#### 调试过程

1. **观察现象**：
   ```
   Pos:200 → PID:6   (Kp × 200 = 0.03 × 200 = 6)
   ```

2. **如果小车不动或反应很慢**：
   ```cpp
   // 增大Kp
   line_follower.setPID(0.05f, 0.0f, 0.0f);
   line_follower.setPID(0.08f, 0.0f, 0.0f);
   line_follower.setPID(0.10f, 0.0f, 0.0f);
   ```

3. **如果小车左右剧烈震荡**：
   ```cpp
   // 减小Kp
   line_follower.setPID(0.04f, 0.0f, 0.0f);
   line_follower.setPID(0.02f, 0.0f, 0.0f);
   ```

4. **找到合适的Kp值**：
   - 小车能跟线
   - 有轻微震荡（这很正常）
   - **记录这个值**，例如：`Kp = 0.06`

---

### 第二步：调D参数（Kd）

**目标**：消除震荡，让运行平滑

```cpp
// 使用第一步得到的Kp值，加入Kd
line_follower.setPID(0.06f, 0.0f, 0.5f);  // Kd从小值开始
```

#### 调试过程

1. **观察震荡情况**：
   - 如果还震荡：增大Kd
   - 如果反应变慢：减小Kd

2. **逐步增大Kd**：
   ```cpp
   line_follower.setPID(0.06f, 0.0f, 1.0f);
   line_follower.setPID(0.06f, 0.0f, 1.5f);
   line_follower.setPID(0.06f, 0.0f, 2.0f);
   ```

3. **找到最佳Kd**：
   - 震荡消失或大幅减小
   - 运行平稳
   - **Kd通常是Kp的10-20倍**

---

### 第三步：调I参数（Ki）（可选）

**什么时候需要Ki？**
- 小车持续偏向一侧（稳态误差）
- 直线时不在中心

**大多数情况Ki=0就够了！**

如果需要：
```cpp
// Ki从极小值开始
line_follower.setPID(0.06f, 0.0001f, 1.5f);
```

**注意**：Ki过大会导致震荡！

---

## 🔧 根据你的数据调试

### 分析你的传感器数据

```
第1行: S:1387 1124 784 375 481 658 962 1587
       分析: 最小值375(传感器3)，最大值1587(传感器7)
       对比度: 1587-375 = 1212 (很好！)
       峰值位置: 传感器3 (反转后最大)
       
第2行: S:1551 1345 965 375 364 469 657 1502
       最小值364(传感器4)，对比度1187
       峰值位置: 传感器3-4之间
       
第3行: S:1647 1403 702 297 278 351 466 1513
       最小值278(传感器4)，对比度1369
       峰值位置: 传感器4偏左
```

### 问题诊断

从你的数据看，线在**中间偏右**，但小车可能：
1. 没有正确转向
2. PID参数太小，输出不够

### 建议的调试参数

#### 方案1：增大Kp（推荐先试这个）
```cpp
// 在main.cpp第125行修改
line_follower.setPID(0.10f, 0.0f, 1.5f);  // 增大Kp到0.10
line_follower.setSpeed(20);  // 降低到20%速度
```

#### 方案2：检查电机方向
你的DriveTrain初始化是：
```cpp
DriveTrain drive_train(motor1, motor3, motor2, motor4);
```

确保：
- `motor1`和`motor2`是左侧电机
- `motor3`和`motor4`是右侧电机

**如果转向反了**，交换motor参数：
```cpp
DriveTrain drive_train(motor2, motor4, motor1, motor3);  // 尝试交换
```

#### 方案3：检查PID输出符号
在`line_follower.cpp`第97行：
```cpp
drive_.setTargetSpeed(base_speed_, -(int16_t)pid_output_);
```

如果转向反了，去掉负号：
```cpp
drive_.setTargetSpeed(base_speed_, (int16_t)pid_output_);
```

---

## 📈 完整调试流程图

```
┌─────────────────────────────────────┐
│  1. 确认硬件和传感器正常              │
│     ✓ 传感器校准完成                 │
│     ✓ 电机能正常转动                 │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  2. 设置低速和小Kp                   │
│     setPID(0.03, 0, 0)              │
│     setSpeed(20)                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  3. 观察小车行为                     │
│     不动/慢 → 增大Kp                │
│     震荡剧烈 → 减小Kp               │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  4. 找到合适Kp（能跟线，轻微震荡）   │
│     记录：Kp = 0.06（示例）          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  5. 加入Kd消除震荡                   │
│     setPID(0.06, 0, 1.0)            │
│     逐步增大Kd直到平稳               │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  6. （可选）加入Ki消除稳态误差       │
│     setPID(0.06, 0.0001, 1.5)       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  7. 逐步提速测试                     │
│     setSpeed(30) → 40 → 50          │
│     可能需要微调Kp和Kd               │
└─────────────────────────────────────┘
```

---

## 🎯 常见问题速查表

| 现象 | 可能原因 | 解决方法 |
|------|---------|---------|
| **小车不动** | Kp太小 | 增大Kp到0.08-0.12 |
| **左右剧烈震荡** | Kp太大 | 减小Kp到0.03-0.05 |
| **能跟线但抖动** | Kd不足 | 增大Kd到1.0-2.0 |
| **转向反了** | 电机接线或PID符号错误 | 检查DriveTrain初始化或改PID符号 |
| **持续偏一侧** | 有稳态误差 | 加入小量Ki (0.0001) |
| **Pos和Err不显示** | 浮点格式化问题 | 已修复，用整数输出 |
| **频繁丢线** | 阈值太高 | 已修复，用对比度检测 |
| **直道正常弯道冲出** | Kd不够或速度太快 | 增大Kd或降速 |

---

## 🔬 进阶技巧

### 1. 根据位置动态调速

```cpp
// 在主循环中添加
float pos = line_follower.getPosition();
if (abs(pos) > 500) {
    // 急弯，减速
    line_follower.setSpeed(20);
} else if (abs(pos) < 200) {
    // 直道，加速
    line_follower.setSpeed(40);
} else {
    // 缓弯，中速
    line_follower.setSpeed(30);
}
```

### 2. 根据速度调整PID

```cpp
void updatePIDBySpeed(int speed) {
    if (speed <= 25) {
        line_follower.setPID(0.06f, 0.0f, 1.0f);  // 低速
    } else if (speed <= 40) {
        line_follower.setPID(0.08f, 0.0f, 1.5f);  // 中速
    } else {
        line_follower.setPID(0.12f, 0.0f, 2.0f);  // 高速
    }
}
```

### 3. 输出数据分析

观察调试输出，寻找规律：
```
Pos:300 Err:300 PID:18 | S:1500 1200 800 350 340 500 900 1600
       ↓
位置偏右300，PID输出18（向右转）
如果小车没反应 → Kp太小
如果转过头 → Kp太大
```

---

## 📝 调试记录模板

建议记录每次调试的参数和效果：

```
测试1:
  参数: Kp=0.03, Ki=0, Kd=0, Speed=20
  现象: 小车不动/反应慢
  结论: Kp太小

测试2:
  参数: Kp=0.08, Ki=0, Kd=0, Speed=20
  现象: 能跟线但震荡严重
  结论: 需要加Kd

测试3:
  参数: Kp=0.08, Ki=0, Kd=1.5, Speed=20
  现象: 平稳跟线
  结论: ✅ 基础参数确定

测试4:
  参数: Kp=0.08, Ki=0, Kd=1.5, Speed=35
  现象: 可以跟线，速度OK
  结论: ✅ 最终参数
```

---

## 🚀 立即开始调试

### 第一次调试建议配置

```cpp
// 在main.cpp第125-126行修改为：
line_follower.setPID(0.08f, 0.0f, 1.2f);  // 推荐起始值
line_follower.setSpeed(20);               // 低速开始
line_follower.enableDebug(true);          // 必须启用
```

### 观察这些关键信息

1. **Pos值**：是否随着小车移动而变化？
2. **PID值**：是否有合理的输出？
3. **小车行为**：是否按照PID输出转向？

如果小车完全不转向，可能是：
- 电机接线问题
- DriveTrain配置问题
- PID符号问题

**祝调试顺利！** 🎉
