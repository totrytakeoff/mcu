# 巡线控制参数完全指南

## 🚨 问题诊断：速度太快、控制太激进

### 根本原因分析

你遇到的问题源于**多层控制参数叠加**：

```
位置范围(-1000~+1000) 
    ↓ × Kp(0.06)
PID输出(-60~+60) 
    ↓ × 缩放系数(默认1.0，太大！)
转向速度(-60~+60)
    ↓ × 转向灵敏度(0.8)
实际转向强度(-48~+48)  ← 太激进了！
```

---

## ✅ 已添加的控制参数

### 新增接口：PID输出缩放

```cpp
// 设置PID输出缩放系数（控制转向强度）
line_follower.setPIDOutputScale(0.1f);  // 范围：0.01-1.0
```

**作用**：直接控制转向强度，是最关键的参数！

---

## 🎯 完整参数体系

### 第一层：基础速度参数

#### 1. 基础速度（base_speed）
```cpp
line_follower.setSpeed(10);  // 范围：0-100
```

**建议值**：
- 初次调试：**5-10**（极慢，便于观察）
- 稳定后：**15-25**
- 正常运行：**30-40**
- 竞速：**50-70**

---

### 第二层：PID参数

#### 2. 比例系数（Kp）
```cpp
line_follower.setPID(0.06f, 0.0f, 1.0f);
                     ↑Kp
```

**作用**：控制对偏差的响应强度

**建议值**：
- 温和：**0.03-0.05**
- 推荐：**0.06-0.08**
- 激进：**0.10-0.15**

**计算示例**：
```
位置偏差：300
Kp = 0.06
原始PID输出 = 300 × 0.06 = 18
```

#### 3. 微分系数（Kd）
```cpp
line_follower.setPID(0.06f, 0.0f, 1.5f);
                               ↑Kd
```

**作用**：抑制震荡，预测趋势

**建议值**：
- 低速：**1.0-1.5**
- 中速：**1.5-2.0**
- 高速：**2.0-3.0**

**通常Kd = Kp × 15~25**

#### 4. 积分系数（Ki）
```cpp
line_follower.setPID(0.06f, 0.0001f, 1.5f);
                          ↑Ki（通常为0）
```

**作用**：消除稳态误差

**大多数情况Ki=0就够了！**

---

### 第三层：PID输出缩放（🌟最关键）

#### 5. PID输出缩放系数
```cpp
line_follower.setPIDOutputScale(0.1f);  // 范围：0.01-1.0
```

**这是控制转向强度的核心参数！**

**建议值**：
| 缩放系数 | 转向强度 | 适用场景 |
|---------|---------|---------|
| **0.05** | 极温和 | 初次调试，观察行为 |
| **0.08** | 温和 | 稳定巡线 |
| **0.10** | 适中 | 推荐值（默认） |
| **0.15** | 中等 | 直道较多 |
| **0.20** | 激进 | 快速反应 |
| **0.30** | 非常激进 | 竞速（慎用） |

**效果对比**：
```
假设：
- 位置偏差：500
- Kp = 0.06
- 原始PID = 500 × 0.06 = 30

缩放系数 = 0.05:  最终转向 = 30 × 0.05 = 1.5  ← 非常温和
缩放系数 = 0.10:  最终转向 = 30 × 0.10 = 3.0  ← 推荐
缩放系数 = 0.20:  最终转向 = 30 × 0.20 = 6.0  ← 激进
缩放系数 = 1.00:  最终转向 = 30 × 1.00 = 30.0 ← 太激进！
```

---

### 第四层：DriveTrain参数

#### 6. 加速度参数
```cpp
// 在main.cpp第115行
drive_train.setAcceleration(3, 5, 8);  // 加速度、减速度、反向减速度
```

**建议值**：
```cpp
// 温和启动（推荐）
drive_train.setAcceleration(3, 5, 8);

// 标准（原配置）
drive_train.setAcceleration(5, 8, 12);

// 激进
drive_train.setAcceleration(8, 12, 15);
```

#### 7. 更新间隔
```cpp
drive_train.setUpdateInterval(20);  // 20ms = 50Hz
```

**固定为20ms即可，不建议修改**

---

## 🔧 参数调整完整流程

### 阶段1：初始化设置（极温和）

```cpp
// 在main.cpp第115-127行修改为：
drive_train.setAcceleration(3, 5, 8);          // 温和加速
line_follower.setPID(0.06f, 0.0f, 1.0f);       // 标准PID
line_follower.setSpeed(10);                    // 极低速
line_follower.setPIDOutputScale(0.05f);        // 极温和转向
line_follower.enableDebug(true);               // 必须启用
```

**目标**：小车能慢速跟线，观察行为

---

### 阶段2：观察调试输出

新的调试输出格式：
```
Pos:300 Err:300 RawPID:18 PID:1 Spd:10 | S:1387 1124 784 375 481 658 962 1587
 ↓       ↓       ↓        ↓    ↓
位置    误差    原始PID  缩放后 基础速度
```

**关键数据解读**：
- `Pos`：线的位置（-1000到+1000）
- `RawPID`：PID原始输出
- `PID`：缩放后的转向速度（这个才是实际控制量）
- `Spd`：基础速度

---

### 阶段3：调整缩放系数

根据小车行为调整`setPIDOutputScale()`：

#### 情况A：小车几乎不转向
```cpp
// 增大缩放系数
line_follower.setPIDOutputScale(0.10f);  // 从0.05增加到0.10
line_follower.setPIDOutputScale(0.15f);  // 再增加到0.15
```

#### 情况B：小车转向剧烈、震荡
```cpp
// 减小缩放系数
line_follower.setPIDOutputScale(0.03f);  // 减小到0.03
```

#### 情况C：转向合适，但反应慢
```cpp
// 保持缩放系数，增大Kd
line_follower.setPID(0.06f, 0.0f, 2.0f);
```

---

### 阶段4：逐步提速

当转向控制稳定后，逐步提高速度：

```cpp
line_follower.setSpeed(15);  // 第一步
// 测试稳定后...

line_follower.setSpeed(20);  // 第二步
// 测试稳定后...

line_follower.setSpeed(25);  // 第三步
```

**注意**：提速时可能需要同步调整：
- 增大Kd（抑制高速震荡）
- 稍微增大缩放系数（补偿惯性）

---

## 📊 参数速查表

### 推荐配置组合

#### 配置1：初次调试（极温和）
```cpp
drive_train.setAcceleration(3, 5, 8);
line_follower.setPID(0.06f, 0.0f, 1.0f);
line_follower.setSpeed(10);
line_follower.setPIDOutputScale(0.05f);  // ← 关键
```

#### 配置2：稳定巡线（推荐）
```cpp
drive_train.setAcceleration(5, 8, 12);
line_follower.setPID(0.08f, 0.0f, 1.5f);
line_follower.setSpeed(25);
line_follower.setPIDOutputScale(0.10f);  // ← 关键
```

#### 配置3：中速运行
```cpp
drive_train.setAcceleration(5, 8, 12);
line_follower.setPID(0.10f, 0.0f, 2.0f);
line_follower.setSpeed(35);
line_follower.setPIDOutputScale(0.12f);  // ← 关键
```

#### 配置4：高速竞速
```cpp
drive_train.setAcceleration(8, 12, 15);
line_follower.setPID(0.12f, 0.0f, 2.5f);
line_follower.setSpeed(50);
line_follower.setPIDOutputScale(0.15f);  // ← 关键
```

---

## 🎯 问题诊断决策树

```
问题：速度太快？
├─→ YES → 降低 setSpeed(10)
└─→ NO  → 继续

问题：转向太激进、震荡？
├─→ YES → 降低 setPIDOutputScale(0.05)
└─→ NO  → 继续

问题：转向合适但抖动？
├─→ YES → 增大 Kd (到2.0-3.0)
└─→ NO  → 继续

问题：转向不够？
├─→ YES → 增大 setPIDOutputScale(0.15)
└─→ NO  → 继续

问题：反应太慢？
├─→ YES → 增大 Kp (到0.10-0.12)
└─→ NO  → 参数合适！
```

---

## 🔬 高级技巧

### 1. 动态调整缩放系数

根据位置偏差动态调整：

```cpp
// 在主循环中
float pos = line_follower.getPosition();
if (abs(pos) > 600) {
    // 大偏差，需要急转
    line_follower.setPIDOutputScale(0.15f);
} else if (abs(pos) < 200) {
    // 小偏差，温和控制
    line_follower.setPIDOutputScale(0.08f);
} else {
    // 中等偏差
    line_follower.setPIDOutputScale(0.10f);
}
```

### 2. 速度自适应参数

```cpp
int speed = 25;  // 当前速度
line_follower.setSpeed(speed);

if (speed <= 20) {
    line_follower.setPID(0.06f, 0.0f, 1.0f);
    line_follower.setPIDOutputScale(0.08f);
} else if (speed <= 35) {
    line_follower.setPID(0.08f, 0.0f, 1.5f);
    line_follower.setPIDOutputScale(0.10f);
} else {
    line_follower.setPID(0.10f, 0.0f, 2.0f);
    line_follower.setPIDOutputScale(0.12f);
}
```

---

## 📝 调试记录表

| 时间 | base_speed | Kp | Kd | scale | 现象 | 结论 |
|------|-----------|----|----|-------|------|------|
| T1 | 10 | 0.06 | 1.0 | 0.05 | 太慢，不转向 | 增大scale |
| T2 | 10 | 0.06 | 1.0 | 0.10 | 能转向，平稳 | ✅ scale确定 |
| T3 | 15 | 0.06 | 1.0 | 0.10 | 有震荡 | 增大Kd |
| T4 | 15 | 0.06 | 1.5 | 0.10 | 平稳 | ✅ 提速 |
| T5 | 25 | 0.06 | 1.5 | 0.10 | 稳定巡线 | ✅ 最终配置 |

---

## ⚠️ 重要提示

### 参数调整优先级（从高到低）

1. **setPIDOutputScale()** ← 最关键！控制转向强度
2. **setSpeed()** ← 控制整体速度
3. **Kd** ← 控制震荡
4. **Kp** ← 控制响应速度
5. **setAcceleration()** ← 控制启停平滑度
6. **Ki** ← 通常保持0

### 调试黄金法则

1. **从温和开始**：宁可太慢，不要太快
2. **一次只调一个参数**：便于定位问题
3. **记录每次调整**：形成调试日志
4. **小步快跑**：每次只微调10-20%
5. **验证稳定性**：每个配置至少跑10圈

---

## 🚀 立即行动

### 第一步：使用极温和配置

在 `src/main.cpp` 第115-127行修改为：

```cpp
drive_train.setAcceleration(3, 5, 8);
line_follower.setPID(0.06f, 0.0f, 1.0f);
line_follower.setSpeed(8);                    // 极低速
line_follower.setPIDOutputScale(0.05f);       // 极温和转向
line_follower.enableDebug(true);
```

### 第二步：观察行为

编译上传后观察：
- 小车是否能慢速跟线？
- RawPID和PID的数值？
- 转向是否足够？

### 第三步：逐步调整

根据观察结果调整 `setPIDOutputScale()`：
- 转向不够 → 增大到0.08, 0.10, 0.12...
- 转向太激进 → 减小到0.03, 0.02...

**现在就去试试吧！** 🎉
